# Nonce Sum

## Abstract

이 노트에서는 TCP 송신기에서 표시된 패킷을 우발적으로 또는 악의적으로 숨기는 것을 방지하는 ECN에 대한 선택적 추가인 ECN(Explicit Congestion Notification)-nonce에 대해 설명합니다. 그것은 수신자가 ECN을 이용하여 네트워크 대역폭의 부당한 점유율을 얻는 것을 방지하여 혼잡 제어의 견고성을 향상시킨다. ECN-nonce는 IP 헤더의 ECN 필드에 있는 두 개의 ECN 지원 전송(ECT) 코드 포인트를 사용하며 TCP 헤더에 플래그가 필요합니다. 이것은 라우터와 호스트 모두에서 계산적으로 효율적이다.

## 1. Introduction

이 규격은 표시된 패킷의 악의적이거나 우발적인 은폐에 대한 견고성을 향상시키는 명시적 정체 알림 [RFC3168]에 대한 선택적 추가에 대해 설명합니다. 그것은 널리 배치되지 않았다. 실험적 RFC로서의 출판의 한 가지 목표는 신중하고, 표준 트랙에 출판하기 전에 사용과 배치를 장려하는 것이다. 방화벽 개발자가 nonce가 제시한 패턴을 인식하고 수용할 수 있는 시간을 주는 것도 고려 사항이다. 더 많은 경험을 얻은 후에 향후 이 규격을 IETF 제안 표준으로 다시 제출하는 것이 운송 영역 작업 그룹의 의도이다.

ECN의 정확한 작동을 위해서는 수신자의 협력이 필요하지만, 프로토콜에는 이러한 협력을 시행할 수 있는 메커니즘이 없다. 이는 비양심적이거나 제대로 구현되지 않은 수신기가 ECN-Echo를 항상 삭제하고 단순히 발신자에게 정체 신호를 반환하지 않을 가능성을 제기한다. 이는 적절하게 동작하는 경쟁 연결을 희생시키면서 수신기에 성능 이점을 제공할 것이다. 보다 일반적으로 경로를 따라 있는 모든 장치(NAT 박스, 방화벽, QOS 대역폭 셰이퍼 등)는 정체 표시를 처벌 없이 제거할 수 있습니다.

상기 동작들은 인터넷에서 혼잡 제어의 동작에 대한 위협이 될 수도 있고 아닐 수도 있다. 그러나 혼잡 제어의 중심 역할을 고려할 때 ECN 신호 루프를 가능한 한 많은 위협에 대해 강력하도록 설계하는 것이 신중하다. 이러한 방식으로 ECN은 남용에 대한 잠재적 인센티브 없이 이전의 최첨단 기술에 비해 개선을 위한 명확한 인센티브를 제공할 수 있다. ECN-난스는 ECN의 잠재적 남용을 제거하기 위한 간단하고 효율적인 메커니즘이다.

ECN-nonce를 사용하면 송신자가 ECN 수신기의 올바른 동작을 확인하고 신호 경로에서 표시된(또는 삭제된) 패킷을 숨기는 다른 간섭이 없음을 확인할 수 있습니다. ECN-nonce는 구현 오류와 의도적인 남용으로부터 보호합니다. ECN-nonce:

- 잘못된 수신기를 높은 확률로 포착하고 무고한 수신기를 연루시키지 않습니다.
- ECN의 다른 측면을 변경하지 않으며, 수신자의 행동에 대한 ECN의 이점을 감소시키지 않는다.
- 패킷당 오버헤드(TCP 헤더 플래그 1개)와 처리 요구 사항 모두에서 저렴합니다.
- 단순하고, 우리가 아는 한, 다른 공격에 취약하지 않습니다.

우리는 또한 드롭테일 라우터만 사용되는 경우에도 ECN-nonce를 사용하면 두 가지 추가적인 이점이 있다는 점에 주목한다. 첫째, 패킷 드롭은 발신자에게 숨길 수 없습니다. 둘째, TCP 세그먼트가 수신되기 전에 승인되는 낙관적인 승인[Savage]을 방지합니다. 이러한 이점은 또한 공격으로 인한 혼잡 제어의 견고성을 높이는 데 도움이 된다. 이 문서에서는 이러한 이점에 대해 자세히 설명하지 않습니다.

이 문서의 나머지 부분에서는 ECN-nonce에 대해 설명합니다. 우리는 송신자와 수신자의 상세한 동작에 이어 개요를 제시한다.

키워드는 이 문서에 나타나는 경우 [RFC2119]에 설명된 대로 해석해야 합니다.

## 2. Overview

ECN-nonce는 기존 ECN-Echo 및 CWR(Congestion Window Reduced) 신호 메커니즘을 기반으로 구축된다. ECN [ECN]에 익숙하다고 가정한다. 단순성을 위해 ECN-nonce는 양방향으로 병렬로 실행되지만 한 방향으로만 설명한다.

TCP에 대한 ECN 프로토콜은 TCP 헤더에서 새 필드의 정의를 제외하고는 변경되지 않습니다. [RFC3168]에서와 마찬가지로 ECT(0) 또는 ECT(1)(ECN 지원 전송)는 발신 패킷의 IP 헤더의 ECN 필드에 설정됩니다. 혼잡한 라우터는 이 필드를 혼잡 경험치(CE)로 변경합니다. TCP 수신기가 CE를 인식하면, ECE(ECN-Echo) 플래그는 CWR 플래그를 수신할 때까지 후속 승인에 설정됩니다. CWR 플래그는 발신자가 정체에 반응할 때마다 새 데이터에 전송됩니다.

ECN-nonce는 이 프로토콜에 추가되며, 수신자가 확인 중인 세그먼트가 표시되지 않은 상태로 수신되었음을 발신자에게 보여줄 수 있습니다. 임의의 1비트 값(논스)은 두 개의 ECT 코드 포인트로 인코딩된다. 이러한 난스의 1비트 합계는 TCP 헤더 플래그인 난스 합계(NS) 비트로 반환됩니다. CE가 두 ECN IP 헤더 비트를 덮어쓰기 때문에 패킷 마킹은 ECT 코드 포인트의 난스 값을 지웁니다. 각 난스는 합계를 계산하는 데 필요하므로 올바른 난스 합계는 표시되지 않은 패킷만 수신함을 의미합니다. 수신기가 표시된 패킷을 숨기는 것을 방지할 뿐만 아니라, 네트워크 경로를 따라 있는 중간 상자는 원래 난스의 값을 성공적으로 추측하지 않고 패킷의 표시를 해제할 수 없습니다.

송신자는 수신자가 반환한 nonce sum을 확인하여 표시된(또는 드롭된) 패킷 형태의 정체 표시가 숨겨지지 않도록 할 수 있습니다. 한 번의 합계가 단지 1비트이기 때문에, 송신자들은 승인이 표시를 숨길 때마다 거짓말을 하는 수신자를 잡을 확률이 50 대 50이다. 각각의 인정은 독립된 재판이기 때문에 반복적인 혼잡 신호가 있을 경우 부정행위자들은 빠르게 적발될 것이다.

다음 단락은 ECN-nonce 프로토콜의 측면을 더 자세히 설명한다.

각 승인은 승인으로 표현되는 바이트 범위에 대한 난스의 1비트 합(배타적 또는 패리티)인 난스 합을 포함한다. 이 합계는 모든 패킷이 개별적으로 승인되는 것은 아니며 패킷이 안정적으로 승인되는 것도 아니기 때문에 사용됩니다. 합계가 사용되지 않은 경우, 표시되지 않은 패킷의 난스는 개별 패킷이 표시되지 않은 상태로 도착했음을 송신자에게 증명하기 위해 메아리칠 수 있다. 그러나 이러한 ACK는 안정적으로 전달되지 않기 때문에 송신자는 표시된 패킷을 숨기기 위해 손실된 ACK와 전송되지 않은 ACK를 구별할 수 없었다. nonce sum은 수신자가 개별 표시된 패킷을 승인하지 않음으로써 은폐하는 것을 방지합니다. 난스와 난스 합은 모두 1비트 양이기 때문에, 그 합은 개별 난스보다 쉽게 추측할 수 없다. 우리는 아래 그림 1에 nonce sum 계산을 보여줍니다.

![스크린샷 2022-11-23 오후 1.29.50.png](Nonce%20Sum%20690665bc50ae4737bebd2da0c2288739/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2022-11-23_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_1.29.50.png)

혼잡이 발생하고 패킷이 표시되거나 손실된 후에는 송신자와 수신자의 난시 합계를 다시 동기화해야 합니다. 패킷이 표시되면 난스가 지워지고 수신기에서 난스의 합계가 더 이상 송신기에서 합계와 일치하지 않습니다. 일단 nons가 손실되면, 추가 손실이 있을 때까지 송신자와 수신자의 nonsum의 차이는 일정하다. 이것은 송신자가 그것의 nonce sum을 수신자의 그것으로 설정하도록 함으로써 혼잡 후에 송신자와 수신자를 재동기화하는 것이 가능하다는 것을 의미한다. 혼잡 표시는 왕복 당 한 번 이상 자주 전달될 필요가 없기 때문에, 송신자는 CWR 신호가 전달되는 동안 확인을 중단하고 새로운 데이터가 확인될 때 수신자의 것으로 그 난스 합계를 재설정한다. 이는 수신기가 재동기화 프로세스에 명시적으로 관여하지 않는다는 이점이 있다. 재동기화 프로세스는 아래 그림 2에 나와 있습니다. ACK 12에서 반환된 nonce sum(NS=0)은 이전 예(NS=1)와 다르며 ACK 16에서 계속 다릅니다.

![스크린샷 2022-11-23 오후 1.31.59.png](Nonce%20Sum%20690665bc50ae4737bebd2da0c2288739/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2022-11-23_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_1.31.59.png)

셋째, 우리는 난스가 패킷과 함께 전송되지만 확인은 바이트 범위를 포함한다는 것을 조정할 필요가 있다. 승인된 바이트 경계는 전송된 경계와 일치할 필요가 없으며, 정보는 다른 바이트 경계를 가진 패킷으로 재전송될 수 있다. 우리는 섹션 6.1에서 수신기가 세그먼트의 일부를 승인할 때 난스를 설정하는 방법인 첫 번째 문제에 대해 논의한다. 두 번째 질문은 더 작은 세그먼트를 큰 세그먼트로 재전송할 때 어떤 nonce를 전송해야 하는지에 대한 간단한 대답입니다. ECN은 재전송에 사용할 수 없으므로 nonce를 전송할 수 없습니다. 재전송은 정체 이벤트와 연관되기 때문에, CWR이 승인되고 정체 이벤트가 끝날 때까지 난스 검사가 중단됩니다.

다음 섹션에서는 송신자, 라우터 및 수신자의 상세한 동작을 설명합니다. 송신자 송신 동작에서 시작하여 ECN 신호 루프 주변, 송신자 확인 처리로 끝납니다.

## 3. Sender Behavior (Transmit)

송신자는 이전과 같이 CWR과 ECN-Echo를 관리합니다. 또한 패킷이 전송될 때 패킷에 난스를 배치하고 수신될 때 확인 응답에서 난스 합계의 유효성을 확인해야 합니다. 이 절에서는 전송 프로세스에 대해 설명합니다.

모든 ECN 지원 IP 패킷에 1비트 온스 값을 지정하기 위해 송신자는 두 개의 ECT 코드 포인트를 사용합니다. ECT(0)는 온스를 0으로, ECT(1)는 온스를 1로 나타냅니다. ECN에서와 마찬가지로, 재전송은 ECN을 지원하지 않으므로, 한 번도 수행하지 마십시오.

송신자는 각 패킷의 끝 시퀀스 번호에서 해당 시퀀스 번호를 포함하는 확인 응답에 예상되는 넌스 합계(원래 전송에 배치된 넌스가 아님)로의 매핑을 유지한다.

## 4. Router Behavior

라우터는 [RFC3168]에 지정된 대로 작동합니다. 패킷을 신호 정체로 표시하면 ECT(0) 또는 ECT(1)에서 난스의 원래 값이 제거됩니다. 원래 난스의 값을 성공적으로 추측하지 않고는 수신자나 다른 어떤 당사자도 패킷의 표시를 해제할 수 없습니다.

## 5. Receiver Behavior (Receive and Transmit)

ECN 난스 수신기는 순서대로 패킷이 도착하고 각 확인 응답에서 현재 난스 합계를 반환할 때 난스 합계를 유지합니다. 수신기 동작은 [RFC3168]과 변경되지 않습니다. ECN-nonce를 지원하지 않는 수신기에 ECN 지원 패킷을 보내는 것을 중단할 수 있으므로 nonce sum을 반환하는 것은 선택 사항이지만 권장됩니다.

승인될 순서가 잘못된 패킷의 대기열에서 패킷이 제거되면 난스는 IP 헤더에서 복구됩니다. 최근 패킷에 대한 승인 시퀀스 번호가 진행됨에 따라 난스가 현재 난스 합계에 추가됩니다.

표시된 패킷의 경우, 하나 이상의 난스 값이 수신기에 알려지지 않을 수 있다. 이 경우 합계를 계산할 때 누락된 난스 값이 무시되고(또는 동등하게 0의 값이 가정됨) ECN-Echo가 송신자에게 정체를 신호하도록 설정됩니다.

주어진 확인에 해당하는 nonce sum을 반환하는 것은 간단하다. TCP 헤더의 단일 "NS"(Nonce Sum) 비트로 전송된다. 이 비트는 아래와 같이 TCP 헤더의 바이트 13에서 비트 7로 설정된 CWR 및 ECN-Echo 비트에 인접합니다.

![스크린샷 2022-11-23 오후 1.40.18.png](Nonce%20Sum%20690665bc50ae4737bebd2da0c2288739/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2022-11-23_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_1.40.18.png)

초기 난스 합은 1이며, 3방향 TCP 핸드셰이크의 SYN/ACK 및 ACK에 포함됩니다. 이를 통해 다른 엔드포인트는 난스 지원을 추론할 수 있지만, SYN/ACK 수신기가 후속 ACK에서 NS를 설정할지 여부를 결정하도록 설정되었는지 확인할 필요가 없다는 점에서 협상이 아니다.

## 6. Sender Behavior (Receive)

이 섹션에서는 보낸 사람이 nonsum의 유효성을 확인하는 방법을 설명하여 보낸 사람 동작에 대한 설명을 완료합니다.

nonce sum은 추가 ECN-Echo 신호가 무시되는 혼잡 복구 중을 제외하고 새로운 데이터의 승인을 수신할 때 확인된다. 검사는 버퍼에 저장된 정확한 넌스 합계와 승인에 저장된 것을 비교하는 것으로 구성되며, 다음 하위 절에 설명된 수정 사항을 사용합니다.

ECN-Echo가 설정되지 않은 경우 수신기는 표시된 패킷을 수신하지 않았다고 주장하므로 정확한 넌스섬을 계산하고 반환할 수 있습니다. 마크를 숨기려면 수신기는 적어도 하나의 패킷이 표시되고 해당 난스가 지워졌기 때문에 수신되지 않은 난스의 합계를 성공적으로 추측해야 한다. 개별 난스가 0 또는 1일 가능성이 동일하다면, 그 합은 0 또는 1일 가능성이 같다. 즉, 어떤 추측도 똑같이 틀릴 가능성이 높고 발신자에게 걸릴 확률이 50 대 50입니다. 각각의 새로운 인정은 독립적인 재판이기 때문에 부정행위를 한 사람은 적은 수의 거짓말 후에 적발될 가능성이 높다.

ECN-Echo가 설정된 경우 수신기가 혼잡 신호를 보내고 있으므로 nonce sum을 확인할 필요가 없습니다. [RFC3168]에서와 같이, congestion 윈도우는 반감되고, 새로운 데이터가 전송된 다음 패킷에 CWR이 설정되며, CWR 신호가 수신되면 ECN-Echo가 소거됩니다. 이 복구 프로세스 중에 하나 이상의 난스가 수신되지 않았기 때문에 합계가 잘못되었을 수 있습니다. TCP는 RTT당 한 번만 congestion 메커니즘을 호출하므로 복구 중에는 문제가 되지 않습니다.

### 6.1 Resynchronization After Loss or Mark

복구 후에는 추가 확인을 확인할 수 있도록 보낸 사람과 수신자의 nonsum을 다시 동기화해야 합니다. 수취인의 합계가 부정확할 경우 추가 손실이 발생할 때까지 부정확한 상태로 유지됩니다.

이것은 혼잡 시간대가 줄어든 후에 보낸 새로운 데이터에 대한 확인 응답을 수신할 때 송신자가 수신자의 그것의 넌스 합계를 재설정하는 간단한 재동기화 메커니즘으로 이어진다. 명시적인 혼잡 신호에 응답할 때, 이것은 ECN-Echo 플래그 세트가 없는 첫 번째 승인이 될 것이다: CWR 플래그를 포함하는 패킷의 승인.

![스크린샷 2022-11-23 오후 1.47.15.png](Nonce%20Sum%20690665bc50ae4737bebd2da0c2288739/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2022-11-23_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_1.47.15.png)

실제로 재동기화는 송신자가 저장한 예상 난스합과 수신 난스합이 CWR 승인에서 다를 경우 1, 그렇지 않을 경우 0의 값을 갖는 비트를 저장함으로써 달성될 수 있다. 그런 다음 이 동기화 오프셋 비트를 사용하여 예상 난스 합계와 수신 난스 합계를 비교할 수 있습니다.

발송인은 ECN-echo 플래그가 표시된 확인서에 반환된 금액을 무시해야 합니다.

IP 패킷을 단편화하는 대신 TCP 계층에서 중간 상자를 다시 분할할 때와 같이 승인이 세그먼트의 일부만 포함하는 경우, 송신자는 다음 세그먼트 경계에서 예상되는 넌스 합계를 받아들여야 합니다. 즉, 원래 세그먼트의 일부를 포함하는 승인은 전체 세그먼트를 승인할 때 예상되는 온스섬을 포함할 것이다.

마지막으로 ECN에서 보낸 사람은 어떤 이유로든 일부 패킷에 ECN 기능을 표시하지 않도록 선택할 수 있습니다. ECN-nonce 송신자는 이러한 ECN-non-capable 패킷을 보낸 후에 다시 동기화해야 합니다. 마치 CWR이 ECN-non-capable 패킷 뒤의 첫 번째 새 데이터와 함께 전송된 것처럼 말이다. 재동기화가 발생할 때까지 보낸 사람은 승인되지 않은 패킷에 대한 보호를 받지 못합니다.

### 6.2 Sender Behavior - Incorrect Nonce Received

잘못된 난스에 대한 보낸 사람의 응답은 정책의 문제입니다. 이는 검사 메커니즘과 별개이며 발신자가 동일하게 처리할 필요가 없습니다. 또한 수신된 비합계를 확인하는 것은 선택 사항이며, 비활성화될 수도 있습니다.

수신자가 0이 아닌 온스 합계를 보낸 적이 없는 경우, 송신자는 수신자가 난스를 이해하지 못한다고 추론할 수 있으며, 연결을 속도 제한하거나, 낮은 우선순위 대기열에 배치하거나, 나가는 세그먼트에서 ECT 설정을 중지할 수 있습니다.

수신된 nonsum이 이전 확인에서 설정된 경우, 송신자는 네트워크 장치가 ECN-nons 지원 엔드포인트 사이의 올바른 ECN 신호를 방해했다고 추론할 수 있다. 잘못된 난스에 대한 최소 응답은 수신된 ECE에 대한 응답과 같습니다. 그러나 숨겨진 혼잡 신호를 보상하기 위해, 송신자는 혼잡 창을 한 세그먼트로 줄이고 나가는 세그먼트에서 ECT 설정을 중지할 수 있다. 잘못된 난스 합계는 ECN-난스 지원 사이의 잘못된 동작 또는 오류 신호입니다.

**6.2.1 Using the ECN-nonce to Protect Against Other Misbehaviors**

ECN-nonce는 표시된 패킷이 송신자에게 신호되는지 확인하는 것 이상의 견고성을 제공할 수 있습니다. 또한 손실된 패킷을 보낸 사람으로부터 숨길 수 없도록 합니다(그들의 난스가 손실되었기 때문에). 드롭은 잠재적으로 결함이 있는 TCP 구현, 특정 공격 또는 가상의 TCP 가속기에 의해 은폐될 수 있다. 이러한 가속기는 미리 설정된 대역폭으로 빠르게 "빠른 시작"하거나, 다른 연결로 재시도하거나, 애플리케이션 수준에서 신뢰성을 제공할 수 있다는 도박을 할 수 있다. 이러한 결함에 대한 견고성도 필요한 경우 ECN-nonce를 비활성화해서는 안 됩니다. 대신 혼잡 시간대를 하나로 줄이거나 우선 순위가 낮은 대기열을 사용하면 지속적인 점검을 제공하면서 잘못된 작동에 불이익을 줄 수 있다.

ECN-nonce는 또한 TCP 성능을 향상시키기 위해 재전송 모호성을 제거하기 위해 최근 제안된 메커니즘인 Eifel[Eifel]에서 잘못된 동작을 감지할 수 있다. 잘못된 수신기는 발신자가 정체 동작을 취소하도록 설득하기 위해 원본 전송만 수신했다고 주장할 수 있습니다. 재전송은 ECT 없이 전송되므로 nonce를 반환하면 원래 전송만 수신되었음을 확인할 수 있습니다.